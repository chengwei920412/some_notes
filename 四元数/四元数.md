[TOC]

## 四元数

### JPL表示方法

#### 四元数表示

##### 四元数定义

在JPL的表示方法中,四元数通常表示如下
$$
\overline{q}=q_{4}+q_{1} \mathbf{i}+q_{2} \mathbf{j}+q_{3} \mathbf{k}
$$
其中i,j和k都是超常数满足
$$
\mathrm{i}^{2}=-1, \quad \mathrm{j}^{2}=-1, \quad \mathrm{k}^{2}=-1
$$

$$
-\mathrm{ij}=\mathrm{ji}=\mathrm{k}, \quad-\mathrm{jk}=\mathrm{kj}=\mathrm{i}, \quad-\mathrm{ki}=\mathrm{ik}=\mathrm{j}
$$

四元数也可表示为
$$
\overline{q}=\left[\begin{array}{l}{\mathbf{q}} \\ {q_{4}}\end{array}\right]=\left[\begin{array}{llll}{q_{1}} & {q_{2}} & {q_{3}} & {q_{4}}\end{array}\right]^{\mathrm{T}}
$$
如果四元数$\mathbf{q}$满足
$$
\mathbf{q}=\left[\begin{array}{l}{k_{x} \sin (\theta / 2)} \\ {k_{y} \sin (\theta / 2)} \\ {k_{z} \sin (\theta / 2)}\end{array}\right]=\hat{\mathbf{k}} \sin (\theta / 2), \quad q_{4}=\cos (\theta / 2)
$$
则$q_1,...,q_4$称为旋转四元数或者欧拉对称参数.$\hat{\mathbf{k}}$是旋转轴的单位向量,$\theta$是旋转角.

旋转四元数同时也是一个单位四元数,满足
$$
|\overline{q}|=\sqrt{\overline{q}^{\mathrm{T}} \overline{q}}=\sqrt{|\mathbf{q}|^{2}+q_{4}^{2}}=1
$$
在后面的表示中,我们会使用"四元数"来表示一个旋转四元数.

四元数$\overline{q}$和四元数$-\overline{q}$表示了旋转到相同的最终坐标系位置,即角度轴表示不是唯一的.**这两个唯一的区别就是到达目标位置的旋转方向,带有正标量元素的四元数$q_4$表示了最短的旋转.**

##### 四元数乘法

四元数的乘法定义为
$$
\begin{array}{} \overline{q} \otimes \overline{p}=&\left(q_{4}+q_{1} \mathbf{i}+q_{2} \mathbf{j}+q_{3} \mathbf{k}\right)\left(p_{4}+p_{1} \mathbf{i}+p_{2} \mathbf{j}+p_{3} \mathbf{k}\right) \\=& q_{4} p_{4}-q_{1} p_{1}-q_{2} p_{2}-q_{3} p_{3}+\left(q_{4} p_{1}+q_{1} p_{4}-q_{2} p_{3}+q_{3} p_{2}\right) \mathbf{i} \\ &+\left(q_{4} p_{2}+q_{2} p_{4}-q_{3} p_{1}+q_{1} p_{3}\right) \mathbf{j}+\left(q_{4} p_{3}+q_{3} p_{4}-q_{1} p_{2}+q_{2} p_{1}\right) \mathbf{k} 
\\ &=\left[\begin{array}{c}{q_{4} p_{1}+q_{3} p_{2}-q_{2} p_{3}+q_{1} p_{4}} \\ {-q_{3} p_{1}+q_{4} p_{2}+q_{1} p_{3}+q_{2} p_{4}} \\ {q_{2} p_{1}-q_{1} p_{2}+q_{4} p_{3}+q_{3} p_{4}} \\ {-q_{1} p_{1}-q_{2} p_{2}-q_{3} p_{3}+q_{4} p_{4}}\end{array}\right]
\end{array}
$$
四元数乘法也能表示为矩阵形式,我们首先介绍一下反对称矩阵
$$
\lfloor\mathbf{q} \times\rfloor=\left[\begin{array}{ccc}{0} & {-q_{3}} & {q_{2}} \\ {q_{3}} & {0} & {-q_{1}} \\ {-q_{2}} & {q_{1}} & {0}\end{array}\right]
$$
叉乘可以被写为
$$
\mathbf{q} \times \mathbf{p}=\left|\begin{array}{ccc}{\mathbf{i}} & {\mathbf{j}} & {\mathbf{k}} \\ {q_{1}} & {q_{2}} & {q_{3}} \\ {p_{1}} & {p_{2}} & {p_{3}}\end{array}\right|=\left[\begin{array}{c}{q_{2} p_{3}-q_{3} p_{2}} \\ {q_{3} p_{1}-q_{1} p_{3}} \\ {q_{1} p_{2}-q_{2} p_{1}}\end{array}\right]=\left[\begin{array}{ccc}{0} & {-q_{3}} & {q_{2}} \\ {q_{3}} & {0} & {-q_{1}} \\ {-q_{2}} & {q_{1}} & {0}\end{array}\right]\left[\begin{array}{c}{p_{1}} \\ {p_{2}} \\ {p_{3}}\end{array}\right]=\lfloor\mathbf{q} \times\rfloor \mathbf{p}
$$
四元数乘法可以写为
$$
\overline{q} \otimes \overline{p}=\mathcal{L}(\overline{q}) \overline{p}
$$

$$
\overline{q} \otimes \overline{p}=\left[\begin{array}{cccc}{q_{4}} & {q_{3}} & {-q_{2}} & {q_{1}} \\ {-q_{3}} & {q_{4}} & {q_{1}} & {q_{2}} \\ {q_{2}} & {-q_{1}} & {q_{4}} & {q_{3}} \\ {-q_{1}} & {-q_{2}} & {-q_{3}} & {q_{4}}\end{array}\right]\left[\begin{array}{c}{p_{1}} \\ {p_{2}} \\ {p_{3}} \\ {p_{4}}\end{array}\right]
$$

$$
\overline{q} \otimes \overline{p}=\left[\begin{array}{cc}{q_{4} \mathbf{I}_{3 \times 3}-\lfloor\mathbf{q} \times\rfloor} & {\mathbf{q}} \\ {-\mathbf{q}^{\mathrm{T}}} & {q_{4}}\end{array}\right]\left[\begin{array}{c}{\mathbf{p}} \\ {p_{4}}\end{array}\right]
$$

$$
\overline{q} \otimes \overline{p}=\left[\begin{array}{cc}{p_{4} \mathbf{I}_{3 \times 3}+\lfloor\mathbf{p} \times\rfloor} & {\mathbf{p}} \\ {-\mathbf{p}^{\mathrm{T}}} & {p_{4}}\end{array}\right]\left[\begin{array}{c}{\mathbf{q}} \\ {q_{4}}\end{array}\right]
$$

$$
\overline{q} \otimes \overline{p}=\left[\begin{array}{cccc}{p_{4}} & {-p_{3}} & {p_{2}} & {p_{1}} \\ {p_{3}} & {p_{4}} & {-p_{1}} & {p_{2}} \\ {-p_{2}} & {p_{1}} & {p_{4}} & {p_{3}} \\ {-p_{1}} & {-p_{2}} & {-p_{3}} & {p_{4}}\end{array}\right]\left[\begin{array}{c}{q_{1}} \\ {q_{2}} \\ {q_{3}} \\ {q_{4}}\end{array}\right]
$$

$$
\overline{q} \otimes \overline{p}=\mathcal{R}(\overline{p}) \overline{q}
$$

对于乘法来说,如果定义了$\overline{q}_{I}=\left[\begin{array}{cccc}{0} & {0} & {0} & {1}\end{array}\right]^{\mathrm{T}}$,那么
$$
\overline{q} \otimes \overline{q}_{I}=\overline{q}_{I} \otimes \overline{q}=\overline{q}
$$
反向旋转由反向或者复共轭四元数表示,
$$
\overline{q}^{-1}=\left[\begin{array}{c}{-\mathbf{q}} \\ {q_{4}}\end{array}\right]=\left[\begin{array}{c}{-\hat{\mathbf{k}} \sin (\theta / 2)} \\ {\cos (\theta / 2)}\end{array}\right]=\left[\begin{array}{c}{\hat{\mathbf{k}} \sin (-\theta / 2)} \\ {\cos (-\theta / 2)}\end{array}\right]
$$

$$
\overline{q} \otimes \overline{q}^{-1}=\overline{q}^{-1} \otimes \overline{q}=\overline{q}_{I}
$$

$$
(\overline{q} \otimes \overline{p})^{-1}=\overline{p}^{-1} \otimes \overline{q}^{-1}
$$

##### 有用的性质

###### L乘和R乘的四元数性质

定义
$$
\begin{array}{ll}{\mathcal{L}=\left[\begin{array}{ll}{\Psi(\overline{q})} & {\overline{q}}\end{array}\right]} \\ {\mathcal{R}=\left[\begin{array}{ll}{\boldsymbol{\Xi}(\overline{p})} & {\overline{p}}\end{array}\right]}\end{array}
$$
其中
$$
\begin{align} \boldsymbol{\Psi} &=\left[\begin{array}{c}{q_{4} \mathbf{I}_{3 \times 3}-\lfloor\mathbf{q} \times\rfloor} \\ {-\mathbf{q}^{\mathrm{T}}}\end{array}\right] \\ \boldsymbol{\Xi} &=\left[\begin{array}{c}{p_{4} \mathbf{I}_{3 \times 3}+\lfloor\mathbf{p} \times\rfloor} \\ {-\mathbf{p}^{\mathrm{T}}}\end{array}\right] \\ \boldsymbol{\Psi}^{\mathrm{T}} \boldsymbol{\Psi} &=\boldsymbol{\Xi}^{\mathrm{T}} \boldsymbol{\Xi}=\mathbf{I}_{3 \times 3} \end{align}
$$
那么
$$
\begin{align} \mathcal{L}\left(\overline{q}^{-1}\right) &=\mathcal{L}^{\mathrm{T}}(\overline{q}) \\ \mathcal{R}\left(\overline{p}^{-1}\right) &=\mathcal{R}^{\mathrm{T}}(\overline{p}) \\ \mathcal{L}^{\mathrm{T}}(\overline{q}) \mathcal{L}(\overline{q}) &=\mathcal{L}(\overline{q}) \mathcal{L}^{\mathrm{T}}(\overline{q})=\mathbf{I}_{4 \times 4} \\ \mathcal{R}^{\mathrm{T}}(\overline{q}) \mathcal{R}(\overline{q}) &=\mathcal{R}(\overline{q}) \mathcal{R}^{\mathrm{T}}(\overline{q})=\mathbf{I}_{4 \times 4} \\ \mathcal{L}(\overline{q}) \mathcal{R}(\overline{r}) &=\mathcal{R}(\overline{r}) \mathcal{L}(\overline{q}) \\ \mathcal{L}(\overline{q}) \mathcal{R}^{\mathrm{T}}(\overline{r}) &=\mathcal{R}^{\mathrm{T}}(\overline{r}) \mathcal{L}(\overline{q}) \end{align}
$$
连乘为
$$
\begin{align} & \overline{p} \otimes \overline{q} \otimes \overline{r} \\=& \mathcal{L}(\overline{p}) \mathcal{L}(\overline{q}) \overline{r} \\=& \mathcal{L}(\overline{p}) \mathcal{R}(\overline{r}) \overline{q} \\=& \mathcal{R}(\overline{r}) \mathcal{L}(\overline{p}) \overline{q} \\=& \mathcal{R}(\overline{r}) \mathcal{R}(\overline{q}) \overline{p} \end{align}
$$
标量乘法为
$$
\begin{align} & \overline{p}^{\mathrm{T}} \overline{r} \\=& \overline{p}^{\mathrm{T}} \mathcal{L}^{\mathrm{T}}(\overline{q}) \mathcal{L}(\overline{q}) \overline{r}=(\overline{q} \otimes \overline{p})^{\mathrm{T}}(\overline{q} \otimes \overline{r}) \\=& \overline{p}^{\mathrm{T}} \mathcal{R}^{\mathrm{T}}(\overline{q}) \mathcal{R}(\overline{q}) \overline{r}=(\overline{p} \otimes \overline{q})^{\mathrm{T}}(\overline{r} \otimes \overline{q}) \end{align}
$$

###### 反对称矩阵叉乘的性质

反交换性为
$$
\lfloor\boldsymbol{\omega} \times\rfloor=-\lfloor\boldsymbol{\omega} \times\rfloor^{\mathrm{T}}
$$

$$
\begin{aligned}\lfloor\mathbf{a} \times\rfloor \mathbf{b} &=-\lfloor\mathbf{b} \times \rfloor  \mathbf{a}\\ \Leftrightarrow \mathbf{a}^{\mathrm{T}}\lfloor\mathbf{b} \times\rfloor &=-\mathbf{b}^{\mathrm{T}}\lfloor\mathbf{a} \times\rfloor \end{aligned}
$$

反对称矩阵的加法
$$
\lfloor\mathbf{a} \times\rfloor+\lfloor\mathbf{b} \times\rfloor=\lfloor\mathbf{a}+\mathbf{b} \times\rfloor
$$
标量的乘法
$$
c \cdot\lfloor\boldsymbol{\omega} \times\rfloor=\lfloor c \omega \times\rfloor
$$
并行向量的叉积
$$
\boldsymbol{\omega} \times(c \cdot \boldsymbol{\omega})=c \cdot\lfloor\boldsymbol{\omega} \times\rfloor \boldsymbol{\omega}=- c \cdot\left(\boldsymbol{\omega}^{\mathrm{T}}\lfloor\boldsymbol{\omega} \times\rfloor\right)^{\mathrm{T}}=\mathbf{0}_{3 \times 1}
$$

###### 矩阵$\Omega$的性质

矩阵$\Omega$表示的是一个向量或者一个四元数的叉乘,
$$
\begin{align} \boldsymbol{\Omega}(\boldsymbol{\omega}) &=\left[\begin{array}{cccc}{0} & {\omega_{z}} & {-\omega_{y}} & {\omega_{x}} \\ {-\omega_{z}} & {0} & {\omega_{x}} & {\omega_{y}} \\ {\omega_{y}} & {-\omega_{x}} & {0} & {\omega_{z}} \\ {-\omega_{x}} & {-\omega_{y}} & {-\omega_{z}} & {0}\end{array}\right] \\ &=\left[\begin{array}{cc}{-\lfloor\boldsymbol{\omega} \times\rfloor} & {\omega} \\ {-\boldsymbol{\omega}^{\mathrm{T}}} & {0}\end{array}\right] \end{align}
$$

##### 四元数和旋转矩阵的关系

给定一个向量$\mathbf{p}$定义为一个四元数
$$
\overline{p}=\left[\begin{array}{l}{\mathbf{p}} \\ {0}\end{array}\right]
$$

两个坐标系下的向量转换为
$$
^{L} \mathbf{p}=_{G}^{L} \mathbf{C}(\overline{q})^{G} \mathbf{p}
$$
其中$\overline{q}=^{L}_{G} \overline{q}$,并且$_{G}^{L} \mathbf{C}(\overline{q})$表示的是从世界坐标系${G}$到局部坐标系$L$的旋转矩阵.

向量也可以通过一个四元数和它的逆进行前乘和后乘来进行变换,如下所示
$$
\begin{align} ^{L} \overline{p}&=^{L}_{G} \overline{q} \otimes^{G} \overline{p} \otimes_{G}^{L} \overline{q}^{-1} \\
&=\left[\begin{array}{c}{\left(2 q_{4}^{2}-1\right) \mathbf{I}_{3 \times 3}-2 q_{4}\lfloor\mathbf{q} \times\rfloor+ 2 \mathbf{q} \mathbf{q}^{\mathrm{T}}} \\ {0}\end{array}\right]\left[\begin{array}{c}{G_{\mathbf{p}}} \\ {0}\end{array}\right] \end{align}
$$
所以,这就给出了四元数和它对应的旋转矩阵的转化方法
$$
_{G}^{L} \mathbf{C}(\overline{q})=\left(2 q_{4}^{2}-1\right) \mathbf{I}_{3 \times 3}-2 q_{4}\lfloor\mathbf{q} \times\rfloor+ 2 \mathbf{q} \mathbf{q}^{\mathrm{T}}
$$
